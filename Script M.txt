let
    vToken = "Bearer eyJhbGciOiJIUzUxMiJ9.eyJpc3MiOiJQaXBlZnkiLCJpYXQiOjE3Njk3ODU1MDAsImp0aSI6IjBjYmZmZmMwLWJiNjMtNDdmOS1hMTgyLThmOTZiODZjYzNhNyIsInN1YiI6MzA3NDQxNzczLCJ1c2VyIjp7ImlkIjozMDc0NDE3NzMsImVtYWlsIjoiYW5kcmVsdWJhbWJpQG9tYXRhcGFsby5jb20ifSwidXNlcl90eXBlIjoiYXV0aGVudGljYXRlZCJ9.q0ADvblqO1VD2ZvoHNw6xmMJd6FiaO9GRTaqk3Xo8UsSTQKyaoELEDAEVgkqILCVHO3aKRS7OQ_5Tc7FLH2S9w",
    vPipeID = Number.ToText(304801263), 
    vUrl = "https://api.pipefy.com/graphql",

    // Função de busca com paginação para garantir os 5000+ cards
    GetCards = (cursor) =>
        let
            vCursor = if cursor = null then "" else "after: """ & cursor & """",
            queryBody = "{ ""query"": ""{ allCards(pipeId: " & vPipeID & ", " & vCursor & ") { pageInfo { hasNextPage endCursor } edges { node { id title createdAt createdBy { name } current_phase { name } fields { name value } } } } }"" }",
            response = Web.Contents(vUrl, [
                Headers = [#"Authorization"=vToken, #"Content-Type"="application/json"],
                Content = Text.ToBinary(queryBody)
            ]),
            json = Json.Document(response)[data][allCards]
        in
            json,

    // Gera a lista de todas as páginas
    AllPages = List.Generate(
        () => [Result = GetCards(null)],
        each [Result] <> null,
        each [Result = if [Result][pageInfo][hasNextPage] then GetCards([Result][pageInfo][endCursor]) else null],
        each [Result][edges]
    ),

    // Consolidação dos dados crus
    #"Tabela Final" = Table.FromList(AllPages, Splitter.SplitByNothing(), null, null, ExtraValues.Error),
    #"Expansão Nodes" = Table.ExpandListColumn(#"Tabela Final", "Column1"),
    #"Campos Extraídos" = Table.ExpandRecordColumn(#"Expansão Nodes", "Column1", {"node"}),
    #"Colunas Detalhadas" = Table.ExpandRecordColumn(#"Campos Extraídos", "node", {"id", "title", "createdAt", "createdBy", "current_phase", "fields"}),
    #"Criador" = Table.ExpandRecordColumn(#"Colunas Detalhadas", "createdBy", {"name"}, {"Criador"}),
    #"Fase Atual" = Table.ExpandRecordColumn(#"Criador", "current_phase", {"name"}, {"Fase Atual"}),
    
    // TRATAMENTO DE ERROS E DUPLICADAS (O "Pulo do Gato")
    #"fields Expandida" = Table.ExpandListColumn(#"Fase Atual", "fields"),
    #"Campos Nome Valor" = Table.ExpandRecordColumn(#"fields Expandida", "fields", {"name", "value"}),
    #"Filtro Nulos" = Table.SelectRows(#"Campos Nome Valor", each ([name] <> null)),

    // Agrupamento para eliminar o erro de "Demasiados elementos"
    #"Agrupado para Evitar Erros" = Table.Group(#"Filtro Nulos", {"id", "title", "createdAt", "Criador", "Fase Atual", "name"}, {
        {"ValorUnico", each List.First(List.RemoveItems([value], {null, ""})), type any}
    }),

    // DINAMISMO TOTAL: O script descobre as colunas sozinho
    ListaDeCampos = List.Distinct(#"Agrupado para Evitar Erros"[name]),
    #"Resultado Final" = Table.Pivot(#"Agrupado para Evitar Erros", ListaDeCampos, "name", "ValorUnico"),
    
    // Toque final: Data da última atualização para o RH
    #"Ultima Atualização" = Table.AddColumn(#"Resultado Final", "Dados Atualizados Em", each DateTime.LocalNow(), type datetime)
in
    #"Ultima Atualização"